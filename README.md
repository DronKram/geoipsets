Geo IP sets
============
Bash script to generate country-specific IPv4/IPv6 network ranges consumable by both *iptables/ipset* and *nftables*. Also included are *systemd* services/timers for both firewalls to periodically update the IP sets.

Introduction
------------
This script makes use of the new *GeoLite2 MaxMind* (updated, free) geoip data. This solution was built and tested in Arch Linux and may require distro-specific modifications.

(Note that Arch actually has a number of geoip database and client packages also based on *MaxMind* data. However, after a cursory review of these, most seemed concerned with retrieving country information based on IPs. There didn't seem to be an obvious way to get the full list of IP ranges for a geographic region. Downloading the CSV files directly seemed the simplest way forward.)

Usage
------------
Install the Bash script to your system.
* curl --remote-name --location https://github.com/chr0mag/geoipsets/archive/v0.5.tar.gz
* tar -zxvf v0.5.tar.gz
* cd geoipsets-0.5
* cp build-country-sets.sh /usr/local/bin/.
* chown root:root /usr/local/bin/build-country-sets.sh
* chmod +x /usr/local/bin/build-country-sets.sh

**iptables/ipset**

Create 2 *ipsets* named *country-ipv4-blacklist* and *country-ipv6-blacklist*.
* ipset create country-ipv4-blacklist hash:net comment
* ipset create country-ipv6-blacklist hash:net family inet6 comment

Insert the blacklist check at the beginning of your *iptables/ip6tables* rules and then persist the changes.
* iptables --insert INPUT --match set --match-set country-ipv4-blacklist src -j DROP
* iptables-save > /etc/iptables/iptables.rules
* ip6tables --insert INPUT --match set --match-set country-ipv6-blacklist src -j DROP
* ip6tables-save > /etc/iptables/ip6tables.rules

**nftables**

Include the file generated by the script from your main *nftables* configuration file and reference the set elements variable. For example:
```
#!/usr/bin/nft -f
flush ruleset

include "/etc/nftables-country.blacklist"
table netdev filter {

	set country-ipv4-blacklist {
		type ipv4_addr
		flags interval
		elements = $country-blacklist
	}
	set country-ipv6-blacklist {
		type ipv6_addr
		flags interval
		elements = $country-ipv6-blacklist
	}
	chain ingress {
		type filter hook ingress device <device> priority 0; policy accept;
		ip saddr @country-ipv4-blacklist counter drop
		ip6 saddr @country-ipv6-blacklist counter drop
	}
}
```

Install the *systemd* service and timer. The example steps below load the *nftset*. If using *iptables/ip6tables/ipset* replace *nftset* with *geoipset*.
* cp nftset.service /etc/systemd/system/.
* cp nftset.timer /etc/systemd/system/.
* chown root:root /etc/systemd/system/nftset.service /etc/systemd/system/nftset.timer
* modify the country list passed to *nftset.service* to suit your needs
* systemctl start nftset.timer
* systemctl enable nftset.timer

Execute the service once manually to initially populate the *country-ipv4-blacklist* and *country-ipv6-blacklist* sets.
* systemctl start nftset.service

Enable the relevant network *wait* service. If using *systemd-networkd* for network setup:
* systemctl start systemd-networkd-wait-online.service
* systemctl enable systemd-networkd-wait-online.service

Sources
------------
* http://ipset.netfilter.org/
* https://dev.maxmind.com/geoip/geoip2/geolite2/
* https://dev.maxmind.com/geoip/geoip2/whats-new-in-geoip2/
* https://superuser.com/questions/997426/is-there-any-other-way-to-get-iptables-to-filter-ip-addresses-based-on-geolocati#997437
* https://wiki.archlinux.org/index.php/Nftables
* https://wiki.nftables.org/wiki-nftables/index.php/Main_Page
* https://unix.stackexchange.com/questions/329971/nftables-ip-set-multiple-tables#331959
* https://www.freedesktop.org/wiki/Software/systemd/NetworkTarget/
