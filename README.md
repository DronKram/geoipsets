Geo IP sets
============
Bash script to generate country-specific IP network ranges consumable by both *iptables/ipset* and *nftables*. Also included are *systemd* services/timers for both *iptables/ipset* and *nftables* to periodically update the IP sets.

Introduction
------------
This script makes use of the new *GeoLite2 MaxMind* (updated, free) geoip data. This solution was built and tested in Arch Linux and may require distro-specific modifications.

(Note that Arch actually has a number of geoip database and client packages also based on *MaxMind* data. However, after a cursory review of these, most seemed concerned with retrieving country information based on IPs. There didn't seem to be an obvious way to get the full list of IP ranges for a geographic region. Downloading the CSV files directly seemed the simplest way forward.)

Usage
------------
Install the Bash script to your system.
* cp build-country-sets.sh /usr/local/bin/.
* chown root:root /usr/local/bin/build-country-sets.sh
* chmod +x /usr/local/bin/build-country-sets.sh

**iptables/ipset**
Create an *ipset* named *country-blacklist*.
* ipset create country-blacklist hash:net comment

Insert the blacklist check at the beginning of your *iptables* rules and then persist the changes.
* iptables --insert INPUT --match set --match-set country-blacklist src -j DROP
* iptables-save > /etc/iptables/iptables.rules

**nftables**
Include the file generated by the script from your main *nftables* configuration file and reference the set elements variable. For example:
```
#!/usr/bin/nft -f
flush ruleset

include "/etc/nftables-country.blacklist"
table netdev filter {

	set country-blacklist {
		type ipv4_addr
		flags interval
		elements = $country-blacklist
	}

	chain ingress {
		type filter hook ingress device <device> priority 0; policy accept;
		ip saddr @country-blacklist counter drop
	}
}
```

Install the *systemd* service and timer. The example steps below load the *nftset*. If using *iptables/ipset* replace *nftset* with *geoipset*.
* cp nftset.service /etc/systemd/system/.
* cp nftset.timer /etc/systemd/system/.
* chown root:root /etc/systemd/system/nftset.service /etc/systemd/system/nftset.timer
* modify the country list passed to *nftset.service* to suite your needs
* systemctl start nftset.timer
* systemctl enable nftset.timer

Execute the service once manually to initially populate the *country-blacklist* set.
* systemctl start nftset.service

Sources
------------
* http://ipset.netfilter.org/
* https://dev.maxmind.com/geoip/geoip2/geolite2/
* https://dev.maxmind.com/geoip/geoip2/whats-new-in-geoip2/
* https://superuser.com/questions/997426/is-there-any-other-way-to-get-iptables-to-filter-ip-addresses-based-on-geolocati#997437
* https://wiki.archlinux.org/index.php/Nftables
* https://wiki.nftables.org/wiki-nftables/index.php/Main_Page
* https://unix.stackexchange.com/questions/329971/nftables-ip-set-multiple-tables#331959
